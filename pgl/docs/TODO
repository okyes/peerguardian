TODO

Note:  items marked with "*" are release-critical for 2.1.0


pgld:

  - replace NIPQUAD (removed from kernel 2.6.36)

  - improve logging: object org/netfilter/pgl/IpMatch consisting of separate
    items (srcip, srcport, destip, destport, proto, description) instead of a
    plain string.

  - use a real allowlist (instead of the iptables whitelisting):
    pgld [OPTIONS] [-A ALLOWLIST(s)] [-B BLOCKLISTS]
    - check packets first against the allowlist, if match: do the same as for
      non-matching against blocklist
    - then check against blocklist (same behaviour as currently)

  - add option to search for a specified IP in a blocklist:
    pgld -f IP BLOCKLIST
    if IP is found in the BLOCKLIST: return 0 and output the matching range(s).
    if IP is not found: return 1

  - make length of range description configurable (with LOWMEM:=range=0)



pglcmd:

  - FIX: on stop (and probably other commands), only dump/reset stats once

  - nice: on CentOS it is required to use e.g. "+5". Find solutions suiting all
    distros.

  - adapt to real allow lists:
    requires allow lists in pgld, see above
    - add configuration file allowlists.lists to handle remote allowlists
      (like blocklists.list for remote blocklists)
    - load all allowlists in a specified folder "allowlists.local"
    - remove variables ALLOW_[IN|OUT|FWD]

  - search function:
    requires search function in pgld, see above.
    Use this function instead of grep'ping for REGEX.

  - use "ip addr" instead of "ifconfig":
    see http://jengelh.medozas.de/2008/0219-ifconfig-sucks.php

  - add dbus support, especially for logging.
    - Completely rework the logging part, and check if all messages go where
      they should.
    - send error messages to console (STDERR 1>&2), logfile and dbus.

  - add pidfile for pglcmd (e.g. to prevent 2 starts at nearly the same time.
    How to handle "update"? - this does not conflict with start.

  - Send traffic to several NFQUEUE nums with --queue-balance and run multiple
    pgld instances for these nums. This might help on heavy load.

    Alternatively increasing the default receive/send window seems to fix the
    problem:
        sysctl -w net.core.rmem_default=8388608
        sysctl -w net.core.wmem_default=8388608
    --
    peerguardian-devel@lists.sourceforge.net by dogg@retroject.net - 2010-04-20

  - on "stop" remove kernel modules that were inserted by pglcmd. (see dino's
    synology packaging http://forums.phoenixlabs.org/showpost.php?p=128371&postc
    ount=20). Probably disable this per default, to avoid problems.

  - fix debconf to use debian/config again.
    This stuff is currently in postinst, because otherwise debconf doesn't work
    as expected: Debconf runs twice during installation: first it asks questions
    and then it overwrites the answers with the not-yet modified configuration
    files.
    Further the debconf database is not cleared properly on purge.

  - adapt test function for peerguardian .p2b v2 binary format blocklist
    formats.

  - [DISCUSS]: if any blocklist is unavailable, should pglcmd exit (as it
    does currently, in order to give no false security), or continue but return
    an error (if one list is missing, it's still better to use at least the
    other blocklists).

  - [DISCUSS] Block IPv6 completely because currently only IPv4 is checked?



pgl-gui:

###############################################################################

  [freemind]

  pgl-gui only:

  - add option "Reset to default"

  * issue a "pglcmd reload" after blocklist selection changes on "Apply".

  - Resize default "Configure - Whitelist - Value" width

  - Implement/Fix/Comment these items:
    - Control Tab:
      - "Blocked IP ranges":
        Remove in favor of "Blocking $X IP ranges ($Y IPs)" in top bar.
        Use last entry in DAEMON_LOG (/var/log/pgl/pgld.log) of:
            "INFO: Blocklist has $X IP ranges ($Y IPs)"
        If this doesn't exist check {DAEMON_LOG}.1 (/var/log/pgl/pgld.log.1)
      - "Last blocklist update":
        - use last entry in CMD_LOG (/var/log/pgl/pglcmd.log) of:
            date +%F" "%X" "%Z" End: pglcmd update
            2011-08-08 10:30:55 CEST End: pglcmd update
        If this doesn't exist check {CMD_LOG}.1 (/var/log/pgl/pglcmd.log.1)
    - Menu - Options - Settings:
      - add hint for the default and/or
      - add "Reset to default" (KDESU_PATH in super_user.h)
    * items on right-click on tray icon:
      * Start, Stop, Restart: (currently no-op), remove or connect to the
        corresponding pglcmd commands.

  - policykit support (instead of kdesudo/gksu)

  - clean up code: get rid of all unused remnants of mobloquer

  - use ${BLOCKLISTS_DIR}/lists.xml to determine human friendly blocklist names
    for URLs like this: http://list.iblocklist.com/?list=ewqglwibdgjttwttrinl&fi
    leformat=p2p&archiveformat=gz
    Also use lists.xml to show the list description.
    Verify that lists like "example.com/list/list2" work.

  - Allow to sort the columns in "Configure - Whitelist" by clicking in their
    header.


  Requires pglcmd dbus:

  - pop-up warning on errors from pglcmd (e.g. blocklist is not available).


  Requires pgld dbus:

  - whitelisting with right-clicking in the log of blocked IPs window:

    * add blocked item (IP or port) to whitelisting (like in "Configure -
      Whitelist").
        if CHAIN = OUT
            DestIp --> WHITE_IP_OUT
            if Protocol = TCP
                DestPort --> WHITE_TCP_OUT
            if Protocol = UDP
                DestPort --> WHITE_UDP_OUT
        if CHAIN = IN
            SrcIp --> WHITE_IP_IN
            if Protocol = TCP
                DestPort --> WHITE_TCP_IN
            if Protocol = UDP
                DestPort --> WHITE_UDP_IN

    - add option to temp allow, which inserts the appropriate iptables rules
      directly (but not to pglcmd.conf). (iptables --ctexpire (really?))

    - add complete blocked item (combination of all IP, port and proto as
      iptables rule to e.g. pgl-gui-iptables-insert.sh).

  - logging:
    - show the log of blocked IPs that happened while pgl-gui was in the tray.

  - blocklists:
    - show local blocklists (in /etc/pgl/blocklists.local) in Configure tab
      (adding them works flawlessly)
    - if blocklists.list is missing and I add a new list, pgl-gui segfaults
-------------------------------------------------------------------------------
(gdb) run
Starting program: /usr/bin/pgl-gui
[Thread debugging using libthread_db enabled]
[New Thread 0x7ffff0ca0700 (LWP 24128)]
** Debug: superuser file:  "/usr/bin/gksu"
** Debug: "/var/log/pgl"
** Warning: QStringList getFileData(const QString&) Could not read from file "/var/log/pgl"
** Warning: void PeerguardianInfo::updateLogData() Failed to retreive information for moblock from file "/var/log/pgl"
[New Thread 0x7fffe5462700 (LWP 24129)]
** Debug: list size:  0
** Debug: list size:  0
** Debug: true
[New Thread 0x7fffe3415700 (LWP 24133)]
[New Thread 0x7fffde4a4700 (LWP 24134)]
** Debug: ~AddExceptionDialog()
[Thread 0x7fffe3415700 (LWP 24133) exited]
[Thread 0x7fffde4a4700 (LWP 24134) exited]

Program received signal SIGSEGV, Segmentation fault.
0x00007ffff6aacf34 in QString::operator=(QString const&) () from /usr/lib/libQtCore.so.4
-------------------------------------------------------------------------------


    - If you stop pgl and send pgl-gui to the tray, and then Exit, you get:
-------------------------------------------------------------------------------
** Warning: Application asked to unregister timer 0x56000008 which is not registered in this thread. Fix application.
-------------------------------------------------------------------------------



###############################################################################

  [jre]

  - Verify flags etc. in Makefile, use variables where possible
    CFLAGS for the C compiler
    CPPFLAGS in any compilation command that runs the preprocessor
    LDFLAGS in any compilation command that does linking as well as in any
        direct use of ld
    verify where prerequisite FORMS_HEADERS is necessary

###############################################################################



All components:

  - use dbus for communication between components. Especially for logging
    events, instead of parsing the logfiles. [partly done]
    change naming to e.g. org/pgl/pgld/...

  - use inotify (available since Linux kernel 2.6.13) to reload after
    configuration change.

  - use doxygen or something like that for automatic documentation.

  - fix/update license headers of pgl-gui and pgld


Packaging:

  - add LOWMEM flavor packages

  - add debtags to debian packages



Web:

  - Update phoenixlabs.org

  - update wiki.phoenixlabs.org
